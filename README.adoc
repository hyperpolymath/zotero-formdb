// SPDX-License-Identifier: AGPL-3.0-or-later
= Zotero-FormDB
:toc:
:toc-placement: preamble
:toclevels: 3

A narrative and provenance based FormDB application for the reference manager Zotero. 
Also works on cloud-drives.

== Quick Start

=== Path A: I Already Use Zotero

You have Zotero with a library. You want FormDB's provenance tracking and cloud-safe storage.

*Time: ~5 minutes*

[source,bash]
----
# 1. Install Julia (if you don't have it)
curl -fsSL https://install.julialang.org | sh
# Then restart your terminal, or run: source ~/.bashrc

# 2. Run the installer (shows what it will do first)
curl -sSL https://raw.githubusercontent.com/hyperpolymath/zotero-formdb/main/install.sh | bash

# 3. If the plan looks good, actually install
curl -sSL https://raw.githubusercontent.com/hyperpolymath/zotero-formdb/main/install.sh | bash -s -- --apply

# 4. Start the server
formdb-server

# 5. Test it
curl http://localhost:8080/users/local/items?limit=3
----

*What just happened:*

* Your Zotero library was copied (not moved!) to `~/.formdb/zotero/`
* Each item now has provenance tracking ("migrated from Zotero")
* You have a Zotero-compatible API server on localhost:8080
* Your original Zotero is untouched and still works normally

*Keep them in sync:*

[source,bash]
----
# With Zotero running, sync any changes to FormDB
formdb-sync
----

=== Path B: I'm New to Reference Management

You've been told this is better than Zotero. You don't have Zotero. Let's get you set up from scratch.

*Time: ~10 minutes*

==== Step 1: Install Zotero (the UI)

FormDB uses Zotero's excellent UI. Install Zotero first:

[source,bash]
----
# Fedora/RHEL
sudo dnf install zotero

# Ubuntu/Debian
sudo apt install zotero

# Or download from: https://www.zotero.org/download/
----

==== Step 2: Install Julia (the engine)

[source,bash]
----
curl -fsSL https://install.julialang.org | sh
# Restart your terminal after this
----

==== Step 3: Open Zotero Once

Open Zotero from your applications menu. This creates your library. You can close it after.

==== Step 4: Install FormDB

[source,bash]
----
# Preview the installation
curl -sSL https://raw.githubusercontent.com/hyperpolymath/zotero-formdb/main/install.sh | bash

# If it looks good, install
curl -sSL https://raw.githubusercontent.com/hyperpolymath/zotero-formdb/main/install.sh | bash -s -- --apply
----

==== Step 5: Daily Workflow

[source,bash]
----
# 1. Use Zotero normally to add papers, books, etc.
#    (Browser connector works, drag-and-drop works, everything works)

# 2. When you want your changes in FormDB, run:
formdb-sync

# 3. To query your library programmatically:
formdb-server &
curl http://localhost:8080/users/local/items
----

=== What Do I Get?

|===
| Feature | Regular Zotero | Zotero + FormDB

| Add papers from browser
| ✓
| ✓ (use Zotero, then sync)

| Organize into collections
| ✓
| ✓

| Cloud sync (Dropbox, etc.)
| ⚠️ Corruption risk
| ✓ Safe (append-only)

| "Who added this?"
| ❌ Not tracked
| ✓ Required

| "Why was this added?"
| ❌ Optional note
| ✓ Required rationale

| Undo any change
| ❌ Hope you have backups
| ✓ Full history

| Query via API
| ❌ Need plugins
| ✓ REST API included

| Evidence quality scores
| ❌
| ✓ PROMPT framework
|===

== Commands Reference

After installation, you have four commands:

[source,bash]
----
formdb-server [--port 8080] [--host 127.0.0.1]
    Start the Zotero-compatible REST API server.
    Your library is available at http://localhost:8080/users/local/items

formdb-sync [--dry-run] [--verbose]
    Sync changes from running Zotero to FormDB.
    Requires Zotero to be open (uses local API on port 23119).

formdb-migrate --apply
    Re-run full migration from Zotero SQLite.
    Use this if sync gets out of date or you want a fresh start.

formdb-score --item KEY [--provenance N] [--methodology N] ...
    Set PROMPT evidence quality scores for an item (v0.2.0).
    Each dimension is 0-100. Use --all N for quick scoring.
    Use --list-unscored to find items needing evaluation.
----

== API Examples

[source,bash]
----
# List all items
curl http://localhost:8080/users/local/items

# Get a specific item
curl http://localhost:8080/users/local/items/ABC12345

# List collections
curl http://localhost:8080/users/local/collections

# Get items in a collection
curl http://localhost:8080/users/local/collections/XYZ98765/items

# Search for items
curl "http://localhost:8080/users/local/items?q=climate+change"

# Filter by item type
curl "http://localhost:8080/users/local/items?itemType=journalArticle"

# Paginate
curl "http://localhost:8080/users/local/items?limit=50&start=100"

# PROMPT Scoring (v0.2.0)
# Set evidence quality scores for an item
curl -X PUT "http://localhost:8080/users/local/items/ABC12345/prompt-scores" \
    -H "Content-Type: application/json" \
    -d '{"provenance": 90, "methodology": 85, "publication": 95}'

# Get PROMPT scores for an item
curl "http://localhost:8080/users/local/items/ABC12345/prompt-scores"

# Filter by minimum quality score
curl "http://localhost:8080/users/local/items?minScore=80"

# Get only items that have been scored
curl "http://localhost:8080/users/local/items?hasScore=true"
----

== Uninstall

[source,bash]
----
# Remove FormDB completely (Zotero is NOT affected)
~/.formdb/uninstall.sh

# Or
curl -sSL https://raw.githubusercontent.com/hyperpolymath/zotero-formdb/main/install.sh | bash -s -- --uninstall
----

== Overview

Zotero-FormDB reimagines bibliographic management for an era where source verification matters. Built on FQL-dt (FormDB Query Language with Dependent Types), it provides:

* **Provenance by construction** - You cannot add an item without saying who added it and why
* **Evidence quality scores** - PROMPT-style ratings (Provenance, Replicability, Objectivity, Methodology, Publication, Transparency)
* **Reversibility proofs** - Every change can be undone, with mathematical proof
* **Cloud-safe storage** - Append-only journal works on Dropbox, GDrive, OneDrive without corruption
* **Machine-checkable integrity** - Types ARE proofs; the compiler verifies your data

== Why Not Just SQLite?

|===
| Problem | SQLite | Zotero-FormDB

| Cloud sync corruption
| Common (concurrent writes)
| Impossible (append-only)

| "Who added this?"
| Optional field, often empty
| Required by type system

| "Is this source reliable?"
| Trust the user
| PROMPT scores with bounds proofs

| "Can I undo this?"
| Maybe, check backups
| Type carries reversibility proof

| "Is data consistent?"
| Runtime checks
| Compile-time proofs
|===

== Architecture

[source,text]
----
┌─────────────────────────────────────────────────────────────┐
│  Zotero (Browser Extension / Desktop App)                   │
│  You keep using Zotero normally                             │
├─────────────────────────────────────────────────────────────┤
│  Sync Bridge (formdb-sync)                                  │
│  Pulls changes from Zotero's local API                      │
├─────────────────────────────────────────────────────────────┤
│  FormDB Journal (append-only)                               │
│  ~/.formdb/zotero/journal.jsonl                             │
│  Content-addressed, hash-chained, provenance-tracked        │
├─────────────────────────────────────────────────────────────┤
│  REST API Server (formdb-server)                            │
│  Zotero-compatible endpoints on localhost:8080              │
├─────────────────────────────────────────────────────────────┤
│  Cloud Storage (optional)                                   │
│  Just copy ~/.formdb/ to Dropbox/GDrive/OneDrive            │
│  Append-only = no corruption from concurrent writes         │
└─────────────────────────────────────────────────────────────┘
----

== Core Types (Lean 4)

[source,lean]
----
-- Every item has provenance by construction
structure ZoteroItem where
  id : ValidUUID
  itemType : ItemType
  added_by : ActorId        -- Non-empty, required
  added_at : Timestamp
  rationale : Rationale     -- Non-empty, required

-- Evidence quality (PROMPT framework)
structure PromptScores where
  provenance : BoundedNat 0 100
  replicability : BoundedNat 0 100
  objective : BoundedNat 0 100
  methodology : BoundedNat 0 100
  publication : BoundedNat 0 100
  transparency : BoundedNat 0 100
  overall : BoundedNat 0 100
  overall_correct : overall.val = (provenance.val + replicability.val +
                    objective.val + methodology.val + publication.val +
                    transparency.val) / 6
----

== DOI Immutability (v0.3.0)

When a document has a DOI, that DOI is a cryptographic promise: "this IS that document."
FormDB treats DOIs as sources of truth for document identity.

=== The Rules

|===
| Operation | Canonical DOI Item | Play-Variant

| Exists as
| Immutable reference
| Editable personal copy

| Edits
| ❌ Blocked (creates variant instead)
| ✓ Allowed

| Notes/Annotations
| ❌ Cannot attach
| ✓ Attach here

| Tags
| ❌ Cannot modify
| ✓ Modify freely

| Identity
| You KNOW it's that document
| Clearly marked as "derived from DOI:xxx"
|===

=== Why This Matters

A DOI identifies THE document as published. When you cite DOI:10.1000/xyz:

* You're citing the canonical, unmodified version
* Not "your copy with annotations"
* Not "a version you edited for clarity"

FormDB enforces this separation so your citations remain valid references to the actual source.

=== How It Works

[source,text]
----
Item with DOI:10.1000/xyz
├── [CANONICAL] The original, immutable
│   └── Cannot be edited, annotated, or tagged
│
└── [PLAY-VARIANT] Your personal copy
    ├── parent_doi: "10.1000/xyz"
    ├── Your annotations
    ├── Your notes
    └── Your tags
----

When you try to edit a DOI item, FormDB automatically:
1. Creates a play-variant linked to the original
2. Applies your changes to the variant
3. Leaves the canonical untouched

== Troubleshooting

=== "Cannot connect to Zotero" when running formdb-sync

Zotero must be running for sync to work. The sync bridge connects to Zotero's local API on port 23119.

[source,bash]
----
# Check if Zotero's API is available
curl http://localhost:23119/api/users/0/items?limit=1
----

=== "Julia not found"

Make sure Julia is installed and in your PATH:

[source,bash]
----
# Install Julia
curl -fsSL https://install.julialang.org | sh

# Restart your terminal, then verify
julia --version
----

=== "Zotero database not found"

The installer looks for Zotero's database in common locations. If yours is elsewhere:

[source,bash]
----
# Find it manually
find ~ -name "zotero.sqlite" 2>/dev/null

# Then run migration manually
cd ~/.formdb/repo/migration
julia --project=. bin/migrate.jl --from /path/to/your/zotero.sqlite --to ~/.formdb/zotero --apply
----

== Roadmap

=== v0.1.0: Core Types + Journal ✓
* Lean 4 type definitions
* Append-only journal format
* SQLite migration tool
* REST API server
* Sync bridge

=== v0.2.0: Evidence Quality ✓
* PROMPT scoring API (GET/PUT /items/:key/prompt-scores)
* Quality-filtered queries (?minScore=80, ?hasScore=true)
* formdb-score CLI for evidence evaluation
* Scores stored in journal with provenance

=== v0.3.0: DOI Immutability (Next)
* DOI items become canonical, immutable references
* Edits to DOI items create "play-variants" (clearly marked forks)
* Notes/annotations can ONLY attach to play-variants
* DOI canonical versions remain pristine - you KNOW it's that document
* `parent_doi` field links variants back to canonical source

=== v0.4.0: Full Integration
* Browser connector plugin
* Desktop app integration
* Real-time sync

== License

AGPL-3.0-or-later

== Related Projects

* link:https://github.com/hyperpolymath/formdb[FormDB] - The underlying narrative-first database engine
* link:https://github.com/hyperpolymath/zotero-librarian[Zotero-Librarian] - Filename normalization tool
* link:https://www.zotero.org[Zotero] - The original reference manager we build on top of
* link:https://github.com/hyperpolymath/formdb-debugger[FormDB Debugger] - Proof-carrying database debugger
